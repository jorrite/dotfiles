#!/bin/bash

set -e

# Source helper library
{{ include ".chezmoitemplates/lib.sh" }}

log_step "ðŸ–¥ï¸  Display Configuration"

# Location of the BetterDisplay CLI
CLI="betterdisplaycli"

# Ensure BetterDisplay CLI is installed
if ! command -v $CLI >/dev/null 2>&1; then
    log_info "BetterDisplay CLI not found, skipping display configuration"
    exit 0
fi

# Only proceed on macOS
if [[ "$(uname)" != "Darwin" ]]; then
    log_info "Not running on macOS, skipping display configuration"
    exit 0
fi

log_substep "Checking for internal display..."

# Only run on machines with an internal display
if ! system_profiler SPDisplaysDataType | grep -q "Connection Type: Internal"; then
    log_info "No internal display found (desktop or external monitor setup)"
    log_info "Skipping display configuration"
    exit 0
fi
log_success "Internal display detected"

log_substep "Detecting native resolution..."

# Get internal built-in display info from system_profiler
INTERNAL=$(system_profiler SPDisplaysDataType | awk '
  BEGIN { found=0 }
  /Display Type:/ { display_type=$0 }
  /Resolution:/ {
    if (index(tolower(display_type),"built-in") > 0) {
      resolution=$2 "x" $4
      found=1
      print resolution
      exit
    }
  }
')

# If no internal display found, do nothing
if [[ -z "$INTERNAL" ]]; then
    log_error "Could not determine internal display resolution"
    exit 1
fi

log_success "Native resolution: $INTERNAL"

# Parse native resolution
WIDTH=$(echo $INTERNAL | cut -dx -f1)
HEIGHT=$(echo $INTERNAL | cut -dx -f2)

# Compute half of native resolution for typical HiDPI
TARGET_WIDTH=$((WIDTH / 2))
TARGET_HEIGHT=$((HEIGHT / 2))

log_substep "Setting HiDPI resolution to ${TARGET_WIDTH}x${TARGET_HEIGHT}..."

# Ensure BetterDisplay is running
if ! pgrep -x "BetterDisplay" >/dev/null; then
    log_info "Starting BetterDisplay..."
    open -g -a "BetterDisplay"
    sleep 2
    
    if ! pgrep -x "BetterDisplay" >/dev/null; then
        log_error "Failed to start BetterDisplay"
        exit 1
    fi
fi

TARGET="${TARGET_WIDTH}x${TARGET_HEIGHT}"

CURRENT=$(betterdisplaycli get --display=internal --resolution 2>/dev/null | cut -d= -f2)

if [[ "$CURRENT" != "$TARGET" ]]; then
    log_info "Applying new resolution..."
    if betterdisplaycli set \
        --display=internal \
        --resolution="$TARGET" \
        --hidpi=on; then
        log_success "Display resolution set to ${TARGET} (HiDPI)"
    else
        log_error "Failed to set display resolution"
        exit 1
    fi
else
    log_success "Display already set to ${TARGET} (HiDPI)"
fi

# Give BetterDisplay a moment to apply the mode
sleep 1

# Quit BetterDisplay cleanly
log_substep "Closing BetterDisplay..."
if osascript -e 'tell application "BetterDisplay" to quit' 2>/dev/null; then
    log_success "BetterDisplay closed"
else
    log_warning "Could not close BetterDisplay cleanly"
fi

echo
log_success "Display configuration complete! ðŸŽ‰"
