#!/usr/bin/env bash
set -e

# Source helper library
{{ include ".chezmoitemplates/lib.sh" }}

show_banner

log_info "This script will guide you through configuring various apps."
log_info "Each app will open with specific instructions."
echo

# Function to open an app and give instructions
open_with_instructions() {
  local app_name="$1"
  local emoji="$2"
  local instructions="$3"

  local has_app=false
  [[ -n "$app_name" ]] && has_app=true

  if $has_app; then
    log_step "${emoji} ${app_name}"
  else
    log_step "${emoji} Instructions"
  fi

  echo -e "${YELLOW}Instructions:${RESET}"
  echo "$instructions"
  echo

  if $has_app; then
    echo -e "${BOLD}Press Enter to open ${app_name}...${RESET}"
    read -r
    open -a "$app_name"
    echo -e "${BOLD}Press Enter after you've completed the configuration...${RESET}"
  else
    echo -e "${BOLD}Press Enter after you've completed the instructions...${RESET}"
  fi
  read -r

  if $has_app; then
    log_success "${app_name} configuration complete"
  else
    log_success "Instructions completed"
  fi
}

# Check if running in VM
if is_virtual_machine; then
    SKIP_MAS_INSTALLED_APPS=true
    log_info "Virtual machine detected - Mac App Store app instructions will be skipped"
else
    SKIP_MAS_INSTALLED_APPS=false
fi

# === DaisyDisk X ===
open_with_instructions "DaisyDisk" "üíæ" \
"Configure the license for DaisyDisk.

License: {{ onepasswordRead "op://afcfz2u36qbb4w5iikx4aol2z4/liyr2tm5gvmrnole6y6e7o5xyu/licentiesleutel" }}"

# === Messages ===
open_with_instructions "Messages" "üí¨" \
"Configure Messages to sync with iCloud.

‚ûú Go to Preferences
‚ûú Enable iCloud sync"

# === Music ===
open_with_instructions "Music" "üéµ" \
"Sign in to Apple Music with your Apple ID."

# === Safari ===
open_with_instructions "Safari" "üß≠" \
"Configure Safari extensions.

‚ûú Go to Safari ‚Üí Settings ‚Üí Extensions
‚ûú Enable/configure your preferred extensions"

# === Transmit ===
open_with_instructions "Transmit" "üöÄ" \
"Configure the license for Transmit.

License: {{ onepasswordRead "op://afcfz2u36qbb4w5iikx4aol2z4/gr34g7tfsl5siuuodubg4vymg4/licentiesleutel" }}"

# === System Settings ===
open_with_instructions "System Settings" "‚öôÔ∏è" \
"I. Configure keyboard shortcuts:

1. Open System Settings ‚Üí Keyboard ‚Üí Keyboard Shortcuts
2. Spotlight:
   ‚ûú Disable Spotlight search shortcuts
3. Screenshots:
   ‚ûú Configure your preferred screenshot shortcuts

II. Hide Menubar Items."

# === CleanShot X ===
open_with_instructions "CleanShot X" "üì∏" \
"CleanShot X requires system permissions:

1. Grant Accessibility permissions when prompted
2. Go to https://licenses.cleanshot.com to activate
3. Configure keyboard shortcuts in preferences"

# === Karabiner-Elements ===
open_with_instructions "Karabiner-Elements" "‚å®Ô∏è" \
"Karabiner-Elements requires system permissions:

1. Grant Input Monitoring permission when prompted
2. Grant Accessibility permission when prompted
3. Configure your keyboard modifications"

# === Control Centre ===
open_with_instructions "" "‚öôÔ∏è" \
"Configure Control Center to only keep these:

1. WiFi
2. Bluetooth
3. Music
4. Focus
5. Dark Mode
6. Sync View
7. Screen brightness
8. Sound"


# === Raycast ===
open_with_instructions "" "‚å®Ô∏è" \
"Raycast will be configured via a backup file.
Import Password: {{ onepasswordRead "op://afcfz2u36qbb4w5iikx4aol2z4/fise2kkom4wx6nolix4lta6mz4/password" }}"

open ~/.config/raycast/config.rayconfig
read -r

if [ "$SKIP_MAS_INSTALLED_APPS" = false ]; then
    # === Things ===
    open_with_instructions "Things3" "‚òëÔ∏è" \
    "Sign in to Things Cloud.

‚ûú Go to Settings ‚Üí Things Cloud
‚ûú Sign in with your account"
fi

echo
show_celebration
